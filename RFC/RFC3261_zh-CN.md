# SIP: Session Initiation Protocol

> 原文 [https://datatracker.ietf.org/doc/html/rfc3261](https://datatracker.ietf.org/doc/html/rfc3261)

## 摘要

本文档描述了会话发起协议（SIP），这是一种应用层控制（信令）协议，用于创建、修改和终止与一个或多个参与者的会话。这些会话包括互联网电话呼叫、多媒体分发和多媒体会议。
用于创建会话的 SIP 邀请包含会话描述，允许参与者就一组兼容的媒体类型达成一致。SIP 使用称为代理服务器的元素来帮助将请求路由到用户的当前位置，对用户的服务进行身份验证和授权，实现提供商呼叫路由策略，并向用户提供功能。SIP 还提供了注册功能，允许用户上传其当前位置供代理服务器使用。SIP 运行在几种不同的传输协议之上。

## 1. Introduction

很多基于网络的应用软件都要求可以实现会话创建和管理，这里的会话可以视为是关联多个参与方交换数据的方式。实际部署这些应用软件是非常复杂的过程：用户可能在几个终端之间移动切换，用户也可能使用多个名字，用户也可能使用不同的媒体，有时还同时使用不同的媒体介质。目前，有很多不同的协议被准许在网络上运行，这些协议来传输各种形式的实时媒体会话数据，例如语音视频，文本信息。 Session Initiation Protocol (SIP) 支持以上所说的这些功能描述和相关的协议，它可以支持开启网络的用户代理来发现其他的终端，准许其他终端的某些会话属性，终端之间可以共享这些会话属性。

为了查询到期望的会话参与对象，和其他的功能，SIP 支持了网络主机设施创建（称为代理服务器），用户代理可以对会话发送注册，邀请和其他的请求。SIP 是一个敏捷，通用的工具，它用来创建，修改和结束会话，它可以不依赖于正在工作的传输协议，并且无需依赖于各种已建立的会话类型。

## 2. Overview of SIP Functionality

SIP 是一种应用层的控制协议，它可以创建，修改和结束多媒体会话（会议），例如网络电话呼叫。SIP 也可以邀请参与对象加入到已存在的会话，例如多方广播会议。它可以从当前存在的会话中再加入媒体也可以移除媒体。SIP 可以透明支持名称映射，转发服务，这些服务功能支持个人移动能力[参考链接 27]- 无论网络位置如何，用户可以在网络中保持一个对外单点可视的身份。

SIP 支持创建和结束媒体通信的五个方面的功能：

- 用户定位: 端系统的决定来支持通信；
- 用户有效性: 决定被呼叫方是否有意愿决定加入通信；
- 用户能力: 决定用户可使用的媒体和其媒体参数；
- 会话创建: "ringing"，在呼叫方和被呼叫方之间创建会话参数；
- 会话管理: 包括转发，结束会话，修改会话参数和调用服务。

SIP 不是一个单一，垂直集成度通信系统。SIP 是一个模块，它可以用来和其他的 IETF 协议集成来构建一个完整的媒体架构。 典型的架构如 ， 和实时传输协议（RTP(RFC1889[28])）配合使用实现实时数据传输，提供 QoS 反馈，使用实时媒体协议（RTSP(RFC2326[29])）来控制媒体流和媒体的发送控制，媒体网关控制协议(MEGACO）(RFC3015[30]) 来控制网关对 PSTN 网络的支持，和会话描述协议(SDP) (RFC2327 [1])来描述媒体会话。因此，SIP 应该结合其他的协议一起使用对用户提供完整的服务。但是，基本的 SIP 功能和操作不会依赖于其他任何协议。

SIP 本身不提供服务。但是，SIP 提供基本的操作，这些操作可以支持部署不同的服务。例如，SIP 可以定位一个用户，并且对当前定位发送一个不透明的对象。如果此基本操作用来支持发送一个写入 SDP 的会话描述，终端可以同意会话中的参数。如果同样的操作用来传递一张呼叫方的图片和此会话描述，那么就可以在早期部署一个 "caller ID" 服务。就像这个例子所展示的，一个单个基本操作往往被用来提供不同的服务。

SIP 不提供会议控制服务，例如发言权控制和发言，它不能对会议发出命令控制以及如何管理会议。SIP 可以用来发起一个会话，这个会话可以用来支持一些会议控制协议。因为 SIP 创建的消息和会话可以传递到完全不同的网络中，SIP 不能也不会提供任何网络资源预设的支持能力。

SIP 所提供的服务的本质使得安全性特别重要。对于对端来说，SIP 提供了一个安全服务单元，这些服务单元包括拒绝攻击防止服务，认证（包括用户对用户，代理对用户），集成保护，加密和私有服务。SIP 可以支持 IPv4 和 IPv6 两种网络环境。

## 3. Terminology

本文档中的关键词“必须”、“不得”、“必需”、“应”、“不应”、“建议”、“不建议”、“可”和“可选”在所有大写字母出现时（如图所示）应按照 BCP 14[RFC2119] [RFC8174] 所述进行解释，并且说明了遵从 SIP 部署要求级别和严格程度。读者需要根据关键词的字面意思来区分这些规则的基本和宽泛程度，尽可能最大程度对应 SIP 协议的要求。很多时候，由于开发人员，特别是对英文协议了解不够，或者对协议的理解不同，所以导致一些兼容性问题或者功能不一致等问题。

## 4. Overview of Operation

此部分使用一个简单示例介绍了 SIP 的基本操作。它实际上是一个学习指导，没有包含任何正式的说明。

第一个示例显示了 SIP 的基本功能：终端定位，希望通信的意愿，创建会话参数的协商和创建会话后会话拆线。

图表 1 显示了一个典型的介于两个用户之间的 SIP 消息交互，两个用户分别是 Alice 和 Bob。(每个消息都通过一个带字母 F 的标签来标注，文本号码说明一个标注号码)。在这个例子中，Alice 使用了一个在 PC 上运行的 SIP 应用程序（作为一个软电话）来呼叫 Bob，Bob 的电话是一个基于互联网的 SIP 电话。这个图例也同时显示了，这里有两个 SIP 代理服务器介于 Alice 和 BoB 之间来支持会话管理工作。在图例 1 中，这种典型的设置方式我们通常称之为 "SIP trapezoid"(SIP 拓扑图)。

Alice 使用自己的 SIP 身份 "呼叫" Bob，这种 SIP 身份是一种 URL 类型，我们这里称之为 SIP URL。SIP URLs 在第 19.1 章节中做了定义。它的格式和邮件的格式非常相 似 ， 一般都包括一个用户名称和主机名称 。 在这个例子中 ， 它就是 `sip:bob@biloxi.com`, 这里 `biloxi.com` 是一个 Bob 的 SIP 服务提供商。Alice 可能也具有和 Bob 的 URL 同样的类型，或点击一个超链接后进入一个地址薄。SIP 同样也提供一个安全的URL ， 被称之为 SIPS URL 。 安全 URL 的示例为 `sips:bob@biloxi.com`。通过 SIPS URL 发起的呼叫可以保证安全，加密的传输，它用来传输所有从呼叫方到被呼叫方域的所有 SIP 消息。 从这里，开始，SIP 的请求消息安全地发送到被呼叫方，但是安全机制依赖于被呼叫方域的安全策略设置。

SIP 是基于一种类似于 HTTP 形式的请求/响应事务处理模式。每个事务处理包括一个启动了特别 method 的请求，或者一个功能，和至少一个来自于服务器端的响应构成。在这个例子中，事务处理是以 Alice 的软电话开始，软电话发送一个 INVITE 请求，携带了 Bob SIP URL 地址。这里，INVITE 就是一个 SIP method ，它指定了一个执行命令，请求方（Alice）想让服务器方（Bob）接收这个请求。这个 INVITE 请求中包含了几个 header fields 字段。Header fields 被命名为属性值，这些属性值提供了关于消息的其他额外信息。在 INVITE 中的某些属性表示了呼叫的唯一身份，目的地地址，Alice 的地址，和 Alice 和 Bob 之间创建会话所期望的会话类型的信息。INVITE (F1 消息中) 可能类似于这样的流程：

```
                 atlanta.com  . . . biloxi.com
             .      proxy              proxy     .
           .                                       .
   Alice's  . . . . . . . . . . . . . . . . . . . .  Bob's
  softphone                                        SIP Phone
     |                |                |                |
     |    INVITE F1   |                |                |
     |--------------->|    INVITE F2   |                |
     |  100 Trying F3 |--------------->|    INVITE F4   |
     |<---------------|  100 Trying F5 |--------------->|
     |                |<-------------- | 180 Ringing F6 |
     |                | 180 Ringing F7 |<---------------|
     | 180 Ringing F8 |<---------------|     200 OK F9  |
     |<---------------|    200 OK F10  |<---------------|
     |    200 OK F11  |<---------------|                |
     |<---------------|                |                |
     |                       ACK F12                    |
     |------------------------------------------------->|
     |                   Media Session                  |
     |<================================================>|
     |                       BYE F13                    |
     |<-------------------------------------------------|
     |                     200 OK F14                   |
     |------------------------------------------------->|
     |                                                  |

     Figure 1: SIP session setup example with SIP trapezoid

```

```
INVITE sip:bob@biloxi.com SIP/2.0
Via: SIP/2.0/UDP pc33.atlanta.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: Bob <sip:bob@biloxi.com>
From: Alice <sip:alice@atlanta.com>;tag=1928301774
Call-ID: a84b4c76e66710@pc33.atlanta.com
CSeq: 314159 INVITE
Contact: <sip:alice@pc33.atlanta.com>
Content-Type: application/sdp
Content-Length: 142

(Alice's SDP not shown)

```

文本消息的第一行包含了一个方法名称 method（INVITE）。 紧接着的是几行包含一个 header 值域的列表。在这个示例中，它们包含了最少的要求设置。这些头header 简单描述如下：

- Via 包含了一个地址(pc33.atlanta.com)，Alice 希望对这个请求获得响应的地址。它也包含了一个 branch 参数来确认这个事务处理。
- To 包含了一个显示名称(Bob)和一个 SIP 或者 SIPS URL（sip:bob@biloxi.com）。Display names 在 RFC2822 [3]有介绍。
- From 也包含一个显示名称 （ Alice ） 和一个 SIP 或 SIPS URI(sip:alice@atlanta.com)，它表示这个请求的发起方。这个 header 同时还有一个一个标签 tag 参数，此标签包含了一个任意字符串（1928301774），这个字符串被添加到了软电话的 URL。此标签也是为了确认身份的目的。
- Call-ID 包含一个对这个呼叫的全局唯一确认信息，它是由一个任意字符串和软电话主机名称或 IP 地址组合而成。To tag 的组合，From tag 的组合，和 Call-ID 完整定义了一个 Alice 和 BoB 两者之间的点对点的 SIP 关系，这种关系可以看作一个dialog 对话。
- CSeq 或 Command Sequence 包含一个整数和一个 method 名称。这个 CSeq 是一个增长的数值，它是支持每一个在 dialog 里新的请求，并且是一个普通的序列号码。
- Contact 包含一个 SIP 或者 SIPS URI，它用来表示一个直接的路由去联系 Alice，通常情况下，它由一个用户名称以及它所在的全限定域名构成（FQDN）。如果使用了全限定域名（FQDN）的话，许多终端系统没有已注册的域名，因此，这里 IP 地址是允许的。Via 头告诉其他参数往哪里发送响应消息，Contact 告诉其他参数往哪里发送将来的请求消息。
- Max-Forwards 最大前转来限定一个请求到达目的地的最大跳跃（hop）数量。它是由一个整数数值构成，在经过一个跳转时会降低一个数值。
- Content-Type 包含一个信息体的描述，这里忽略。
- Content-Length 包含计算消息体长度的八位位组（字节）。

完整的 SIP 头字段集在 20 章节中有详细的定义。

会话的细节，例如媒体类型，编码，采样率等没有在 SIP 中进行描述。 这些细节而是包含在了 SIP 消息体中，它们通过编码以后以各种协议的格式出现。其中一种协议格式就是 会话描述协议 -- Session Description Protocol (SDP) (RFC2327 [1])。这个SDP 消息（没有在这里显示）示例是通过 SIP 消息来传输，传输的方式类似于电子邮件中的附件方式来传输，或类似于通过 HTTP 消息传输网页页面内容的方式。

因为软电话不知道 Bob 的地址或 biloxi.com 域名中的 SIP 服务器地址，软电话发送一个 INVITE 到 SIP 服务器端，这个 SIP 服务器支持 Alice 的域，atlanta.com。atlanta.com SIP 服务器已经配置了 Alice 的软电话，或者通过 DHCP 发现了软电话地址信息。

这个 atlanta.com SIP 服务器是一个代理服务器。代理服务器接收请求，然后作为一个请求者转发这些请求。在这个实例中，代理服务器接收到了 INVITE 请求，然后发送了一个 100 (Trying) 响应给 Alice 的软电话。这个 100 (Trying) 响应表示这个INVITE 已经被收到，代理正在通过路由设置路由这个 INVITE 到其目的地。在 SIP 中，响应消息使用一个三位数的响应码和描述短语作为回复消息。这个响应消息在 Via 中包括同样的 To，From，Call-ID，CSeq 和 branch 参数 parameter，这些参数和 INVITE 中的一样，这些参数允许 Alice 的软电话关联响应消息来发送 INVITE 消息。这个 atlanta.com 代理服务器定位到这个代理服务器在 biloxi.com，它可能执行一个特别的 DNS 查询来找到服务 biloxi.com 域的 SIP 服务器。这个部分的描述在[参考链接 4]中。 因此，它获得 biloxi.com 代理服务器的 IP 地址，然后转发或者在这里代理其 INVITE 请求。在转发这个请求之前，这个 atlanta.com 代理服务器添加另外一个 Via 头字段，这个头字段包含自己的地址（这个 INVITE 已经在第一个Via 包含了 Alice 的地址）。biloxi.com 代理服务器收到这个 INVITE 消息后，然后回复一个带 100 (Trying) 响应消息到 atlanta.com 代理服务器，表示它已经收到了这个 INVITE 消息，正在处理这个请求。代理服务器会查询一个定位服务器，我们称之为定位服务，定位服务包含当前 Bob 的 IP 地址。(我们将会在下一个部分看到如何实现数据库查询。)biloxi.com 代理服务器会添加另外一个 Via header ，并且携带自己的 IP 地址，这个地址是针对这个 INVITE 请求的，代理转发这个请求到 Bob 的 SIP 软电话。

Bob 的软电话收到这个 INVITE 消息后，对 Bob 发出提示，告诉他有从 Alice 来的电话呼叫，Bob 决定是否应答这个呼叫，这里 Bob 的软电话会产生振铃提示。Bob 的软电话提示 180 振铃，这个响应消息会路由根据相反的方向回到两个代理服务器。每个代理使用 Via header 域值来决定发送响应的地址方向，并且从顶部路由记录中删除自己的地址。因此，尽管要求 DNS 和定位服务查询 路由这个初始的 INVITE 请求，180（Ringing）响应返回到呼叫方时可以没有查询消息或没有代理服务器中所保持的状态。

这样也获得了一个合理的响应属性，每个看到 INVITE 消息的代理服务器也可以看到所有对 INVITE 的响应消息。

当 Alice 的软电话收到这个 180 (Ringing)响应后，它会传递这个信息给 Alice，传递过来的信息方式可以使用一个回铃音（ringback tone）或者在 Alice 终端屏幕显示一个消息。

在这个示例中，Bob 决定应答这个呼叫。当他拿起电话听筒时，他的 SIP 电话会发送一个 200 (OK) 响应消息来表示这个呼叫已经应答。这个 200 (OK) 包含了一个消息体，这个消息体带了这个呼叫会话的媒体描述类型，这个媒体描述中说明了 Bob 希望和 Alice 创建会话。因此，这里有一个两阶段的 SDP 消息交互过程：Alice 发送一个交互消息给 Bob，Bob 然后发送了一个交互消息给 Alice。 这个两阶段的交互提供基本的协商能力，它是基于一个简单的 offer/answer SDP 交互模式来进行的。 如果 Bob 不希望应答这个呼叫或者 Bob 电话可能被占线，他此时和其他人进行通话，那么 Bob 终端则会发送一个错误响应消息而不是 200 (OK)，这样就会导致没有媒体创建的情况。 完整的 SIP 响应码在 第 21 节中列出。Bob 发送的 200 (OK) (图例 1 中的消息 F9)可能类似于这样：

```
SIP/2.0 200 OK
Via: SIP/2.0/UDP server10.biloxi.com;branch=z9hG4bKnashds8;received=192.0.2.3
Via: SIP/2.0/UDP bigbox3.site3.atlanta.com;branch=z9hG4bK77ef4c2312983.1;received=192.0.2.2
Via: SIP/2.0/UDP pc33.atlanta.com;branch=z9hG4bK776asdhds ;received=192.0.2.1
To: Bob <sip:bob@biloxi.com>;tag=a6c85cf
From: Alice <sip:alice@atlanta.com>;tag=1928301774
Call-ID: a84b4c76e66710@pc33.atlanta.com
CSeq: 314159 INVITE
Contact: <sip:bob@192.0.2.4>
Content-Type: application/sdp
Content-Length: 131

(Bob's SDP not shown)
```

响应消息的第一行包含了响应码(200)和响应原因短语(OK)。其余其他行消息包含 header 值域消息。Via，To， From， Call-ID，和 CSeq header 值域都是从 INVITE 请求中拷贝过来的。(注意，这里有三个 Via 头值，一个是 Alice 软电话添加的，另外一个是 atlanta.com 代理服务器添加到，还有一个是 biloxi.com 代理添加的)。Bob 的软电话已经在 header 中添加了一个 taq 标签参数 To。这个标签将会在两个终端的 dialog 中使用，也将会在此呼叫后续的请求和响应使用。

Contact 头包含了一个 URL 地址，这个 URL 就是 Bob 可以直接访问的软电话地址。 Content-Type 和 Content-Length 参考消息体（这里没有列出），这个消息包含了 Bob SDP 媒体的信息。

另外，在这个示例中，DNS 和定位查询显示代理服务器可以做一个灵活的路由决定，它可以决定往哪里发送请求。例如，如果 Bob 软电话返回一个 486 (Busy，忙状态)响应的话，biloxi.com 代理服务器可以代理这个 INVITE 到 Bob 的语音邮箱服务器。代理服务器也可以同时发送一个 INVITE 到多个地址。这种类型的并行查询方式称之为 forking（分叉复制）处理方式。

在这个示例中，200 (OK) 消息通过两个代理服务器返回到 Alice，Alice 软电话收到响应消息，软电话停止回铃音，表示呼叫已应答。最后，Alice 软电话发送一个确认消息 ACK，这个消息发送到 Bob 软电话来确认最终响应 (200 (OK))已收到。在这个示例中，这个 ACK 是通过 Alice 软电话直接被发送到了 Bob 软电话，发送过程绕开了两个代理服务器。这样处理的原因就是因为两个终端已经通过互相学习知道对方的地址，双方地址是通过 INVITE/200（OK）交互时的 Contact 头获得，当然这个地址在初始时的 INVITE 是双方都不知道的。两个代理服务器的查询服务也不需要，因此，代理服务器则会退出这个呼叫流程。这个处理过程成功实现了 INVITE/200/ACK 三方握手，并且创建了 SIP 会话。完整的关于 SIP 会话创建的细节，请参考第 13 章节。

Alice 和 Bob 之间的媒体会话启动，他们之间的软电话开始发送媒体数据包，媒体数据包的格式是他们之间的 SDP 交互互相同意支持的格式。一般来说，端对端的媒体数据通过不同的路径发送，而不是使用 SIP 信令消息的路径。

在这个会话过程中，Alice 或 Bob 任何一方都可以有权决定修改媒体会话的属性。修改会话属性是通过发送一个 re-INVITE 消息，在此消息中包含一个新的媒体描述来实现。这个 re-INVITE 涉及到了已存在的 dialog,因此其他的参与方知道这个消息是修改了现在的会话，而不是重新建立的新会话。其他方发送一个 200（ok）接受这个修改。请求方对 200（ok）发送一个 ACK。如果其他方不能接受这个修改的话，它会发生一个错误响应，例如 488 (Not Acceptable Here)，同样也接收一个 ACK 确认消息。但是，这个 re-INVITE 失败不会导致目前的呼叫失败-这个会话仍然会继续使用以前协商的属性。完整的话会修改细节，请阅读第 14 章节内容。

在呼叫结束后，Bob 首先挂机(hangs up)，并且生成一个 BYE 消息。这个 BYE 会直接路由返回到 Alice 的软电话，这里仍然绕过了代理。 Alice 确认了 BYE 接收，发送一个 200（ok），结束这个会话和 BYE 消息事务。这里没有 ACK 发送，ACK 发送仅发生在对 INVITE 请求的响应中。对于对 INVITE 特别处理的原因会在后续的章节中讨论，这里涉及了 SIP 中的可靠性机制问题，振铃应答的时间程度和分叉处理等因素。因为这个原因，SIP 中的请求处理经常被划分为 INVITE 或者 non-INVITE 两个层面，除了 INVITE method 以外，还涉及其他的所有 methods 。完整的关于会话结束的详情将在第 15 章节进行讨论。

第 24.2 章节描述了在 Figure1 的完整的消息构成。

在某些用例中，对于代理来说可能非常有用，在整个会话期间可以看到两个终端之间在 SIP 信令路径上的所有消息。例如，如果 biloxi.com 代理服务器希望保持除了初始 INVITE 以外的 SIP 消息，它对 INVITE 添加一个要求的路由 header 值，这个值我们称之为 Record-Route，用来解析主机或者代理的 IP 地址。因为 Bob 软电话（这个消息会通过 200（OK）传送回 Bob）和 Alice 软电话将会收到这个消息，在整个 dialog 过程中保存这个消息。biloxi.com 代理服务器将收到和对 BYE 代理转发这个 ACK，BYE 和 200（OK）。每个代理可以独立决定收到的后续的消息，消息将被通过所有选择接收的代理发送，这些代理来接收这个消息。这个能力经常被代理使用，代理通过这个能力可以提供 mid-call 功能或者呼叫期间的控制功能。

注册是另外一个 SIP 常用的操作。注册是一种方法，它可以使得 biloxi.com 服务器获知当前 Bob 的位置。Bob 软电话基于初始化处理，在一定周期内 Bob 软电话对在 biloxi.com 的服务器发送 REGISTER 消息，我们称之为 SIP registrar 或者 SIP 注册。REGISTER 消息关联 Bob 的 SIP 软电话或者 SIPS URI (sip:bob@biloxi.com)，这个机器是当前 Bob 写入记录的地址（它在 Contact 头中传输 SIP 或者 SIPURL）。 这个注册会写入此关联，也被称之为在数据库中的绑定或者定位服务，此定位服务可以使用在 biloxi.com 域的代理中。经常，对于一个域的注册服务器需要和这个域的代理协同工作。这里一定要注意，区分不同类型的 SIP 服务器功能概念是非常重要的，它们区别是在于逻辑处理的不同，而不是物理上，形体上的不同。

Bob 不仅仅局限于从一台设备注册。例如，Bob 的两个终端设备，一台在家里面，另外一台在办公室都发送注册消息。两台设备的消息都保存在定位服务中，允许代理执行各种对 Bob 终端的定位查询。

同样的道理，同一时间，多个用户可以注册到一台单个设备上。

定位服务仅是一个抽象概念。通常情况下，它包括一些必要的信息，它支持代理输入一个 URL，并且接收零个或多个 URL，这些 URL 告诉代理往什么地址发送请求。注册是一种方式来创建这些信息，但也不仅仅是这一种方式。任意映射功能可以通过管理员自行决定。

最后，一定要注意，在 SIP 中注册是用来路由入局的 SIP 请求的，它不能充当出局的授权请求的角色。在 SIP 中，鉴权和身份认证的处理可以基于逐一请求的方式，使用 challenge/response 机制的方式来处理，或使用更低一层的方案来处理，这种方案的讨论在第 26 章节有所描述。

完整的关于 SIP 注册的消息细节示例在第 24.1 章节讨论。

其他的 SIP 操作 ， 例如查询 SIP 服务器的能力或终端使用 OPTIONS ， 或使用 CANCEL 取消正在进行的请求等流程将会在后续章节进行讨论。

## 5. Structure of the Protocol

SIP 是按照一定的层级结构创建的协议，这表示它的行为是根据一系列各自相对独立的处理流程来实现，每个处理阶段之间是松耦合关系。协议行为描述为多个层级，这样是为了支持呈现的目的，支持标准的函数描述，这些描述涉及了单一环境的多个网元。 它不能通过任何方式来决定部署。当我们说一个网元要 “包含” 一个层级时，我们的意思是它符合一系列在这个层级所定义的规范规则。

不是每个通过协议设定的网元都包含在每个层级。进一步说，在 SIP 协议中设定的网元是逻辑网元，不是物理形态的网元。一种物理实现可以选择不同的逻辑网元来执行，也许可以基于依次事务对事务的处理方式进行。

SIP 结构的最低层是语法和解码层 。 解码是通过增强的 Backus-Naur Formgrammar (BNF) 语法来实现的。完整的 BNF 在第 25 章节有介绍。整个 SIP 消息结构的总览在第 7 章节介绍。

第二层是传输层。它定义了用户如何发送请求，如何接收响应和服务器如何通过网络接收请求和发送响应。所有 SIP 网元都包含一个传输层。传输层是在第 18 章节进行描述。

第三层是事务层。事务是 SIP 的基础核心模块。事务是一个由用户端事务对服务器端事务发送的请求，用户端使用传输层对服务器端发送事务请求，所有的服务器端事务所携带响应消息返回到客户端。事务层处理应用层的重传，对请求响应的匹配和应用层超时管理。 任何由用户代理（UAC）完成的任务通过使用一系列的事务来触发。

具体的关于事务的讨论在第 17 章有讨论。 用户代理包含了一个事务层，就像是一个状态代理。 无状态代理没有包含事务层。事务层有一个用户端模块（称之为用户事务）和一个服务器端事务模块（称之为服务器端模块），每个模块通过各自的有限状态机来呈现，状态机来处理每个特别的请求。

在事务层上面的是事务用户（TU）。每个 SIP 实体，除了无状态代理都是一个事务用户。当一个 TU 希望发送一个请求时，它会创建一个用户事务实例，然后把这个实例传递给这个请求，并且携带目的地 IP 地址，端口和传输请求。一个创建了用户事务的 TU 也可以取消这个用户事务。当用户取消了一个事务时，它会请求服务器停止进一步的处理，变换到退出的状态，这个状态是这个事务初始化前的退出状态，并且生成对这个事务生成错误响应消息。 这个处理过程是通过一个 CANCEL 请求来处理，它构成了属于自己的事务，但是仅针对这个被取消的事务（第 9 章）。

SIP 网元也就是用户代理客户端，服务器，无状态代理，有状态代理和注册。SIP 网元包含了一个核心模块，这个核心模块来对各自其网元进行区别处理。在核心网元模块中，除了无状态代理以外，其他的网元都是事务用户。这里，UAC 和 UAS 的核心处理流程由来于 method。关于 methods 支持了多种规则和定义（第 8 章）。对于 UAC 来说，这些规则控制请求的结构；对于 UAS 来说，这些规则控制请求的流程和生成响应消息。因为注册在 SIP 协议中扮演着一个非常重要的角色，一个处理注册的 UAS 会设定一个特别的名称注册。在第 10 章中描述了 UAC 和 UAS 核心的对 REGISTER method 的处理方式。第 11 章描述了 UAC 和 UAS 核心对 OPTIONS method 的处理方式，它决定 UA 的支持能力。

某些其他的请求是在 dialog 中发送。一个 dialog 是一个介于用户代理之间的 peer-to-peer SIP 关系，这种关系存在于一定时间内。 这个 dialog 支持介于用户代理之间的消息的顺序传递和正确的请求路由。在这个细节规定中，INVITE method 是唯一的方法来创建 dialog。当一个 UAC 在 dialog 中发送一个请求时，它会遵守一般的 UAC 规则，这些规则在会第 8 章加以讨论，它也会遵守 mid-dialog 请求时的规则。第 12 章讨论在 dialog 和表述它们的结构和维护流程。

在 SIP 协议中，最重要的 method 是 INVITE method，它用来创建参与方之间的会话。一个会话是参与方的汇集和它们之间通信的的媒体流交互。第 13 章讨论了如何实现会话发起，这些导致了一个或者多个 SIP dialog 生成。 第 14 章讨论了如何在一个 dialog 中通过 INVITE 用法来修改会话属性。最后，在第 15 章中讨论如何结束一个会话。

章节 8，10，11，12，13，14, 和 15 完整讨论了 UA core(第 9 章描述了取消流程，这个取消流程支持都支持 UA core 和 proxy core)。 第 16 章讨论代理的网元，这些网元支持了介于两个用户代理之间的信息路由。

## 6. Definitions

以下定义对 SIP 协议非常重要。

- **Address-of-Record**: 一个 address-of-record (AOR) 是一个 SIP 或者 SIPS URI 地址， 它指到了一个域，同时它支持定位服务。定位服务可以映射这个 URL 到其他的 URL，其他的 URL 可能绑定了用户的有效性和可用性。典型的示例是,定位服务通过注册来实现。AOR 经常被认为是一个用户的“公开地址”。
- **Back-to-Back User Agent**: 背靠背用户代理（B2BUA）是一个逻辑实体，它作为一个 UAS 来接收一个请求，处理这个请求。为了决定如何应答这个请求，它的工作方式又类似于一个 user agent client (UAC) 来生成请求。 不像代理服务器，它会保持 dialog 状态，并且必须介入到整个它所创建的 dialogs 中发送的所有请求。因为它自己本身就是一个 UAC 和 UAS 的结合体，本身并不需要特别明确的定义来定义它的行为。
- **Call**: 呼叫是一个非正式的名称，它指的是介于终端之间的通信，通常情况下创建呼叫的目的是为了多媒体的沟通。
- **Call Leg**: dialog 另外的名称[参考链接 31]；已不在此规定中使用。
- **Call Stateful**: 一个代理是有状态呼叫，它具有这样的特征。如果它保持 dialog 整个状态，这个状态一直持续从初始化 INVITE 开始到 BYE 请求结束。 一个 call stateful 代理总是一个事务状态，但是事务状态不一定是一个有状态呼叫代理。
- **Client**: 终端用户是任何一个网络的网元，它发送 SIP 请求和接收 SIP 响应。用户端可能，或不可能直接和真人用户进行互动。用户代理终端和代理是终端。
- **Conference**: 一个多媒体会话，它包含了多个参与方。
- **Core**: Core 指定了某些功能，这些功能专门针对某些 SIP 实体的参与方类型。例如，具体指定了是一个状态或者非状态代理，用户代理或者注册。除了某些非状态代理以外，所有的 core 功能都是事务用户。
- **Dialog**: dialog 是一种端对端的 SIP 关系，它介于两个 UA 之间，这两个 UA 在一定时间内维持着某种绑定关系。一个 dialog 的创建是通过 SIP 消息，例如对 INVITE请求的 2xx 响应。一个 Dialog 是通过 一 个 call identifier，local tag，和一个 remote tag 来定义的。 Dialog 以前称之为一个 call leg，call leg 在 RFC2543 定义。
- **Downstream**: 在事务内的一个消息前转的，它涉及到了一个请求流程，这个请求流程是从用户代理客户端到用户代理服务器端的处理方向。
- **Final Response**: 是一个响应消息，它结束 SIP 事务，相反的，一个 provisional response 则不会结束事务。所有 All 2xx，3xx，4xx，5xx 和 6xx responses 都是最终响应消息。
- **Header**: 头是 SIP 消息的组件，它传递消息的信息。它由一系列的头字段值构成。
- **Header Field**: 头是 SIP 消息的组件。一个头字段或者头字段可以表现为一个或多个头字段值。每一行头字段值包含头字段值名称和一个或者多个头字段值。如果有多个头字段值的话，可以通过逗号分开。一些头字段值仅有单行头字段，它总是以单行头字段出现。
- **Header Field Value**: 一个头字段或者字段是一个单个数值；它由零个或多个头字段值构成。
- **Home Domain**: 主机域对 SIP 用户提供服务。典型的解释是，这是一个域名，它出现在注册 AOR 的 URL 中。
- **Informational Response**: 类似于一个临时响应。
- **Initiator, Calling Party, Caller**: 一方发起一个会话（dialog） ，它带着一个 INVITE 请求。 一个呼叫方始终保持一个角色，这个角色从它开始发送这个初始的INVITE 开始计算，这个 INVITE 创建了一个 dialog，一直到结束这个 dialog。
- **Invitation**: 一个 INVITE 请求。
- **Invitee, Invited User, Called Party, Callee**: 一方接收一个 INVITE 请求，这个请求的目的是为了创建一个新的会话。被呼叫方始终保持这个角色，这个角色从它开始接收这个 INVITE 开始计算，一直到 dialog 结束，这个 dialog 是由那个 INVITE 创建。
- **Location Service**: 定位服务用来支持一个 SIP 重定位或代理服务器来获得关于被呼叫方可能存在的地址信息。它包含一个绑定的 address-of-record 列表数值，这些从从零个到多个 contact 地址。这个绑定关系可以通过多种方式来创建或者删除；此协议细节中定义了一个 REGISTER method 来更新绑定关系。
- **Loop**: 一个已到达代理的请求，经过前转以后，后来又返回到同样的代理。当这个请求第二次到达代理时，这个请求的 Request-URI 确认是第一次的请求，并且其他影响代理操作的头字段值不会改变，因此代理会在这个请求中做出和第一次同样的处理决定。回环的请求是一种错误，流程会检侧回环请求，通过协议本身来处理这种回环请求。
- **Loose Routing**: 如果代理遵守本规范来处理路由头字段，代理会被告知是一个松散路由。 这些流程从一系列的代理中分开了目的地请求（出现在 Request-URL 中），代理所遵守的机制被称之为松散路由。
- **Message**: 消息是在 SIP 网元之间发送的数据，它是协议的一部分。SIP 消息可以是请求或者响应消息。
- **Method**: method 是一个基本功能，一个请求在服务器端被激活。Method 在请求自己的消息中传输。常见的 methods 是 INVITE 和 BYE 请求。
- **Outbound Proxy**: 它是一个代理，负责接收从客户端发出的请求，即使它可能不是一个通过 Request-URI 解析度服务器。 通常情况下，一个 UA 可以通过 outbound proxy 手动配置，或通过自动配置协议进行学习。
- **Parallel Search**: 在并行查询中，一个代理会对可能存在的用户位置发送几个请求，这些可能存在的用户位置用来接收请求。而且，并行查询也不是发送一个请求，然后等待收到这个请求的最后响应，然后发送接下来的请求。它不会等到前面的请求响应收到以后再发送下一个请求。
- **Provisional Response**: 它是临时响应，临时响应表示服务器端的处理进程， 但是临时响应不会结束 SIP 事务。1xx 是临时响应，其他的响应是最终响应。
- **Proxy, Proxy Server**: 代理是一个中间实体，它的工作方式既是一个服务器端，又是一个客户端，作为客户端的作用是支持其他客户端发起请求。代理服务器基本功能是扮演路由的角色，它的工作就是确保请求被发送到比较接近目标用户的其他实体。代理也可以执行一些强制的策略（例如，确保用户被允许呼叫）。 代理可以解析请求消息的部分消息内容，如果必要的话，在一个请求消息被前转之前，代理可以重写请求消息的部分参数内容。
- **Recursion**: 递归处理。当用户在响应中的 Contact 头字段中产生一个或多个 URLS 的新请求时，用户会在 3xx 响应中产生递归。
- **Redirect Server**: 重定向服务器是一个用户代理服务器，它会对接收的请求产生 3xx响应，重新定向用户，让用户联系其他可选的 URL 列表中的 URI 地址。
- **Registrar**: 注册服务是一个注册服务器，它用来接受 REGISTER 请求，负责把注册服务器接受的信息保存到定位服务所支持的 domain，这个 domain 是注册服务器负责。


## 7. SIP Messages

## 8. General User Agent Behavior

## 9. Canceling a Request

## 10. Registrations

## 11. Querying for Capabilities

## 12. Dialogs

## 13. Initiating a Session

## 14. Modifying an Existing Session

## 15. Terminating a Session

## 16. Proxy Behavior

## 17. Transactions

## 18. Transport

## 19. Common Message Components

## 20. Header Fields

## 21. Response Codes

## 22. Usage of HTTP Authentication

## 23. S/MIME

## 24. Examples

## 25. Augmented BNF for the SIP Protocol

## 26. Security Considerations: Threat Model and Security Usage Recommendations

## 27. IANA Considerations

## 28. Changes From RFC 2543

## 29. Normative References

## 30. Informative References

## A. Table of Timer Values

