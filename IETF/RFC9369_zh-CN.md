# QUIC Version 2

> 原文 [https://datatracker.ietf.org/doc/html/rfc9369](https://datatracker.ietf.org/doc/html/rfc9369)

## 摘要

本文档指定了 QUIC 版本 2，除了一些琐碎的细节外，它与 QUIC 版本 1 完全相同。其目的是对抗各种僵化载体，并行使版本协商框架。它还可以作为 QUIC 未来版本中最小更改的模板。

请注意，"版本 2" 是该提案的非正式名称，表明它是作为标准跟踪文件发布的第二个 QUIC 版本。此处指定的方案在导线图像中使用除 2 以外的版本号，以最大限度地降低协议僵化风险。

## 1. Introduction

QUIC 版本 1[QUIC] 有许多扩展点，包括占据每个长标头的第二到第五个字节的版本号（请参见[QUIC-INVARINTS]）。如果实验版本很少，并且 QUIC 版本 1 构成了 QUIC 流量的绝大多数，则网络中间件有可能在通常在 0x00000001 的版本字节上僵化。

在 QUIC 版本 1 中，初始数据包使用版本特定的 salt 加密，如 [QUIC-TLS] 第 5.2 节所述。以这种方式保护初始数据包允许观察者检查其内容，其中包括 TLS 客户端 Hello 或服务器Hello 消息。同样，网络中间件有可能僵化版本 1 的密钥推导和数据包格式。

最后，[QUIC-VN] 描述了端点可以用来协商选择哪个 QUIC 版本的两种机制。"不兼容" 的版本协商方法可以支持从任何 QUIC 版本切换到具有完全通用性的任何其他版本，代价是在连接开始时额外往返。"兼容" 版本协商消除了增加往返的弊端，但对两个版本在语义上的差异施加了一些限制。

QUIC 版本 2 旨在缓解僵化问题并运用版本协商机制。这些更改提供了指定新 QUIC 版本所需的最小更改集的示例。然而，请注意，连接上版本号的选择是随机选择的，而不是 "2"，并且标识每个长头数据包类型的两个位与版本 1 不同；这两种特性都是为了对抗协议僵化，并不是新的 QUIC 版本所严格要求的。
任何支持两个版本的端点都需要实现版本协商，以防止降级攻击。

## 2. Conventions

本文中的关键词"MUST"，"MUST NOT"，"REQUIRED"，"SHALL"，"SHALL NOT"，"SHOULD"，"SHOULD NOT"，"RECOMMENDED"，"NOT RECOMMENDED"，"MAY"，以及"OPTIONAL"，只有当他们全部以大写字母出现的时候，需要按 BCP 14[RFC2119][RFC8174]所述的方式进行理解。

## 3. Differences with QUIC Version 1

除少数差异外，QUIC 版本 2 端点必须实现如 [QUIC]、[QUIC-TLS] 和 [QUIC-RECOVERY] 中所述的QUIC版本1规范。本节的其余部分列出了差异。

### 3.1. Version Field

长标头的 Version 字段为 `0x6b3343cf`。这是通过获取 "QUICv2 version number" 的 sha256sum 的前四个字节生成的。

### 3.2. Long Header Packet Types

所有版本 2 的长包头数据类型都不同。"Type" 字段值为：

- Initial: `0b01`
- 0-RTT: `0b10`
- Handshake: `0b11`
- Retry: `0b00`

### 3.3. Cryptography Changes

#### 3.3.1. Initial Salt

[QUIC-TLS] 第 5.2 节中用于导出初始密钥的 salt 更改为：

```
initial_salt = 0x0dede3def700a6db819381be6e269dcbf9bd2ed9
```

#### 3.3.2. HMAC-based Key Derivation Function (HKDF) Labels

[QUIC-TLS] 中用于导出数据包保护密钥（第 5.1 节）、头保护密钥（第一节第 5.4 节）、重试完整性标记密钥（第 5.8 节）和密钥更新（第 6.1 节）的标签

- 从 "quic key" 变为 "quicv2 key"
- 从 "quic iv" 变为 "quicv2 iv"
- 从 "quic hp" 变为 "quicv2 hp"
- 从 "quic ku" 变为 "quicv2 ku"

以满足该文件第 9.6 节中对新版本的指导。

#### 3.3.3. Retry Integrity Tag

用于重试完整性标记的密钥和随机数（[QUIC-TLS]第 5.8 节）更改为：

```
secret =
  0xc4dd2484d681aefa4ff4d69c2c20299984a765a5d3c31982f38fc74162155e9f
key = 0x8fb4b01b56ac48e260fbcbcead7ccc92
nonce = 0xd86969bc2d7c6d9990efb04a
```

该密钥是 "QUICv2 retry secret" 的 sha256sum。密钥和 nonce 是从这个秘密中派生出来的，分别带有标签 "quicv2 key" 和 "quicv2 iv"。

## 4. Version Negotiation Considerations

QUIC 版本 2 不打算弃用版本 1。支持版本 2 的端点可能会继续支持版本 1，以最大限度地提高与其他端点的兼容性。特别是，HTTP 客户端经常使用 Alt-Svc[RFC7838] 来发现对 QUIC 的支持。由于该机制目前无法区分 QUIC 版本，HTTP 服务器应支持多个版本，以降低不兼容的可能性以及与 QUIC 版本协商或 TCP 回退相关的成本。例如，Alt-Svc 中对 "h3" 的原始建议支持应该支持 QUIC 版本 1，因为它是 HTTP/3 使用的原始 QUIC 版本；因此，一些客户端将只支持该版本。
任何支持 QUIC 版本 2 的 QUIC 端点都必须发送、处理和验证 [QUIC-VN] 中指定的 version_information 传输参数，以防止版本降级攻击。
请注意，版本 2 符合 [QUIC-VN] 中与版本 1 兼容的版本的定义，并且版本 1 与版本 2 兼容。因此，服务器可以使用兼容协商在两个版本之间切换连接。支持两个版本的端点应该支持兼容的版本协商，以避免多余的往返。

### 4.1. Compatible Negotiation Requirements

版本 1 和版本 2 之间的兼容版本协商在任何方向上都遵循相同的要求。本节使用 [QUIC-VN] 中的术语 "原始版本"(original version) 和 "协商版本"(negotiated version)。

如果服务器发送 "retry" 数据包，则必须使用原始版本。客户端忽略使用其他版本的 "retry" 数据包。客户端在包含重试令牌的后续初始数据包中不得使用其他版本。服务器可以在其重试令牌中对 QUIC 版本进行编码，以验证客户端是否未切换版本，并在切换后丢弃数据包，以强制遵守客户端要求。

QUIC 版本 2 使用与 QUIC 版本 1 相同的传输参数来验证重试。重试后切换到协商版本后，服务器必须包括相关传输参数，以验证服务器是否发送了重试和交换中使用的连接 ID，如[QUIC] 第 7.3 节所述。

在处理完客户端的传输参数之前，服务器无法发送 CRYPTO 帧。服务器必须使用协商的版本发送所有 CRYPTO 帧。

客户端通过观察与原始版本不同的第一个长头 version 字段来学习协商的版本。如果客户端从服务器接收到原始版本的 CRYPTO 帧，则表示协商的版本等于原始版本。

在服务器能够处理来自客户端的传输参数之前，它可能需要响应来自客户端的初始数据包。对于这些数据包，服务器使用原始版本。

一旦客户端了解到协商的版本，就应该使用该版本发送后续的 Initial 数据包。在成功处理具有协商版本的握手数据包之前，服务器不得丢弃其原始版本的初始接收密钥。

两个端点都必须使用协商的版本发送握手和 1-RTT 数据包。端点必须使用任何其他版本丢弃数据包。端点不需要生成允许它们解密或认证这样的分组的密钥材料。

客户端不得使用协商版本发送 0-RTT 数据包，即使在处理了来自服务器的该版本的数据包之后也是如此。服务器可以接受 0-RTT，然后处理来自原始版本的 0-RTT 数据包。

## 5. TLS Resumption and NEW_TOKEN Tokens

TLS 会话凭证和 NEW_TOKEN 令牌特定于提供它们的连接的 QUIC 版本。客户端不得使用来自 QUIC 版本 1 连接的会话凭证或令牌来启动 QUIC 版本 2 连接，反之亦然。当连接包括兼容的版本协商时，任何发布的服务器令牌都被视为源自协商的版本，而不是原始版本。

服务器必须验证任何会话票证或令牌的原始版本，并且不接受从不同版本发出的票证或令牌。被拒绝的票证会导致回退到完全 TLS 握手，而没有 0-RTT。被拒绝的令牌会导致客户端地址未经验证，从而限制服务器可以发送的数据量。

在兼容版本协商之后，任何生成的会话票证都映射到协商的版本，而不是原始版本。

## 6. Ossification Considerations

QUIC 版本 2 提供防止某些形式骨化的保护。假设所有长标头都将编码版本 1，或者版本 1 初始密钥推导公式将保持版本不变的设备将无法正确处理版本 2 数据包。

然而，许多网络中间件（如防火墙）将重点放在连接中的第一个数据包上，出于上述考虑，该数据包通常保持在版本 1 格式。

有兴趣对抗网络僵化的客户端可以使用版本 2 启动连接，如果他们合理地确定服务器支持它，并且如果他们不正确，他们愿意遭受增加往返负担。特别地，发布版本 2 的会话票证的服务器指示在票证保持有效的同时保持版本 2 支持的意图，即使不能保证支持。

## 7. Applicability

与 QUIC 版本 1 相比，QUIC 版本 2 对应用程序可用的功能没有任何更改。因此，指定在 QUIC 版本 1 上操作的所有应用层协议协商（ALPN）[RFC7301]码点也可以在该版本的 QUIC 上操作。特别是，"h3"[HTTP/3] 和 "doq"[RFC9250] ALPN都可以在 QUIC 版本 2 上运行。

除非另有说明，所有定义为与版本 1 一起使用的 QUIC 扩展也与版本 2 一起使用。

## 8. Security Considerations

QUIC 版本 2 不对 QUIC 版本 1 的安全或隐私属性进行任何更改。

强制性的版本协商机制可以防止降级攻击，但由于版本属性相同，因此降级没有安全隐患。

对 QUIC 版本 2 的支持可以帮助观察者对客户端和服务器设备进行指纹识别。
